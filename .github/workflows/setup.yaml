name: "Setup Server"
run-name: "Setup Server"
on:
  workflow_dispatch:
    inputs:
      setupServer:
        description: "Do you want to setup the current server?"
        type: boolean
        default: false

env:
  DOMAIN: digiwezo.tech
  NGINX_CONFIG_PATH: "${{ vars.NGINX_CONFIG_PATH }}"

jobs:
  setup:
    name: "Setup Server"
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.setupServer == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: deployment/scripts/
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Mask sensitive variables
        run: |
          echo "::add-mask::${{ env.NGINX_CONFIG_PATH }}"

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.REMOTE_IP }} >> ~/.ssh/known_hosts

      - name: Verify server connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} "echo 'Server connection successful'"

      - name: Create SSL certificates directory and upload the certifications
        run: |
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} << 'EOF'
            sudo mkdir -p /etc/ssl/cloudflare
            sudo chmod 755 /etc/ssl/cloudflare
          EOF

          # Upload SSL certificate
          echo "${{ secrets.SSL_CERTIFICATE }}" | ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} \
            "sudo tee /etc/ssl/cloudflare/${{ env.DOMAIN }}.pem > /dev/null"

          # Upload SSL private key
          echo "${{ secrets.SSL_PRIVATE_KEY }}" | ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} \
            "sudo tee /etc/ssl/cloudflare/${{ env.DOMAIN }}.key > /dev/null"

          # Upload SSL trusted certificate
          echo "${{ secrets.SSL_TRUSTED_CERTIFICATE }}" | ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} \
            "sudo tee /etc/ssl/cloudflare/cloudflare_chain.pem > /dev/null"

          # Set correct permissions
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} << 'ENDSSH'
            sudo chmod 644 /etc/ssl/cloudflare/${{ env.DOMAIN }}.pem
            sudo chmod 600 /etc/ssl/cloudflare/${{ env.DOMAIN }}.key
            sudo chmod 644 /etc/ssl/cloudflare/cloudflare_chain.pem
            sudo chown root:root /etc/ssl/cloudflare/${{ env.DOMAIN }}.*
          ENDSSH

      - name: Upload the setup script
        run: |
          scp ./setup-server.sh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }}:~/setup-server.sh
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} "chmod +x ~/setup-server.sh"

      - name: Run server setup script
        run: |
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} << ENDSSH
            sudo ~/setup-server.sh \
            --username "${{ secrets.REMOTE_USER }}" \
            --domain "${{ env.DOMAIN }}" \
            --install-docker "true" \
            --install-nginx "true"
          ENDSSH

      - name: Upload Nginx configuration
        working-directory: ${{ github.workspace }}
        run: |
          scp deployment/nginx/prod.nginx.conf ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }}:~/frontend.conf

          # Replace the domain placeholder and move to nginx directory
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_IP }} << 'ENDSSH'
            sudo sed -i "s/DOMAIN_PLACEHOLDER/${{ env.DOMAIN }}/g" ~/frontend.conf
            sudo rm /etc/nginx/conf.d/*
            sudo mv ~/frontend.conf ${{ env.NGINX_CONFIG_PATH }}
            sudo nginx -t
            sudo systemctl reload nginx
          ENDSSH

      - name: Start a debug session
        if: failure()
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
